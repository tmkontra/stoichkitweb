<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="author" content="">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Load React. -->
    <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <link href="css/style.css" rel="stylesheet">
</head>

<body>
<div class="container">
    <h1>StoichKit Web</h1>
    <div class="container d-flex">
        <div id="reaction-form"></div>
    </div>
</div>

<script src="js/script.js"></script>
<script>
    'use strict';

    const e = React.createElement;

    class ReactionForm extends React.Component {
        newReagent = () => {
            return {
                formula: "",
                mass: null,
                coeff: 1,
            }
        };

        constructor(props) {
            super(props);
            this.state = {
                reagents: [this.newReagent()],
                product: this.newReagent(),
                yield: null,
            };
        }

        inputClass = "form-control";

        rglist = () => {
            var inputs = this.state.reagents.map((rg, i) => {
                const updateFormula = (event) => {
                  let reagents = [...this.state.reagents];
                  reagents[i].formula = event.target.value;
                  this.setState({
                      ...this.state,
                      reagents: reagents
                  })
                };
                const updateMass = (event) => {
                    let reagents = [...this.state.reagents];
                    reagents[i].mass = Number(event.target.value);
                    this.setState({
                        ...this.state,
                        reagents: reagents
                    })
                };
                const updateCoeff = (event) => {
                    let reagents = [...this.state.reagents];
                    reagents[i].coeff = Number(event.target.value);
                    this.setState({
                        ...this.state,
                        reagents: reagents
                    })
                };
                return [
                    e("h4", {}, `Reagent ${i+1}`),
                    e("div", {className: "d-flex flex-row justify-content-between"},
                        e("div", {className: "form-group p-2"},
                            e("label", {}, `Formula`),
                            e("input", {type: "text", className: this.inputClass, value: this.state.reagents[i].formula, onChange: updateFormula}),
                        ),
                        e("div", {className: "form-group p-2"},
                            e("label", {}, `Amount (g)`),
                            e("input", {type: "number", className: this.inputClass, value: this.state.reagents[i].mass, onChange: updateMass}),
                        ),
                        e("div", {className: "form-group p-2"},
                            e("label", {}, `Stoich. Coefficient`),
                            e("input", {type: "number", className: this.inputClass, value: this.state.reagents[i].coeff, onChange: updateCoeff})
                        )
                    )
                ]
            });
            return e(
                "div",
                {},
                ...inputs
            )
        };

        p = () => {
            const updateFormula = (event) => {
                var product = this.state.product;
                this.setState({
                    ...this.state,
                    product: {
                        ...product,
                        formula: event.target.value
                    }
                })
            };
            const updateMass = (event) => {
                var product = this.state.product;
                this.setState({
                    ...this.state,
                    product: {
                        ...product,
                        mass: Number(event.target.value)
                    }
                })
            };
            const updateCoeff = (event) => {
                var product = this.state.product;
                this.setState({
                    ...this.state,
                    product: {
                        ...product,
                        coeff: Number(event.target.value)
                    }
                })
            };
            return e(
                "div",
                {className: "mb-4"},
                e("h4", {}, "Product"),
                e("div", {className: "d-flex flex-row justify-content-between"},
                    e("div", {className: "form-group p-2"},
                        e("label", {}, `Formula`),
                        e("input", {type: "text", className: this.inputClass, value: this.state.product.formula, onChange: updateFormula}),
                    ),
                    e("div", {className: "form-group p-2"},
                        e("label", {}, `Amount (g)`),
                        e("input", {type: "number", className: this.inputClass, value: this.state.product.mass, onChange: updateMass}),
                    ),
                    e("div", {className: "form-group p-2"},
                        e("label", {}, `Stoich. Coefficient`),
                        e("input", {type: "number", className: this.inputClass, value: this.state.product.coeff, onChange: updateCoeff})
                    )
                )
            )
        };

        addReagent = (ev) => {
            ev.preventDefault();
            this.setState({
                reagents: [
                    ...this.state.reagents,
                    this.newReagent()
                ]
            })
        };

        onSubmit = (ev) => {
            ev.preventDefault();
            const URL = "http://localhost:3030/yield";
            alert(`${JSON.stringify(this.state)}`);
            fetch(
                URL,
                {
                    mode: 'cors',
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'localhost'
                    },
                    body: JSON.stringify(this.state)
                }
            )
                .then(res => res.text())
                .then(
                    (result) => {
                        this.setState({
                            yield: result
                        });
                    },
                )
        };

        render() {
            let yieldDisplay;
            if (this.state.yield) {
                yieldDisplay = [e("h4", {className: "mt-4"}, e("p", {}, "Yield:"), e("p", {}, `${this.state.yield}`))];
            } else {
                yieldDisplay = []
            }

            return e(
                'form',
                {},
                e("div", {className: ""},
                    e("div", {},
                        this.rglist(),
                        e("button", {className: "btn btn-secondary mb-4", onClick: this.addReagent}, "Add a Reagent")
                    ),
                    e("div", {},
                        this.p(),
                        e("button", {className: "btn btn-primary submit", onClick: this.onSubmit}, "Submit"),
                        ...yieldDisplay
                    )
                )
            );
        }
    }

    const domContainer = document.querySelector('#reaction-form');
    ReactDOM.render(e(ReactionForm), domContainer);
</script>
</body>


</html>
